name: Ethereum Testnet CI
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  testnet:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Start Node + Deploy
      shell: bash
      run: |
        mkdir -p nodes/node1/data
        docker compose up -d
        i=1
        while [ "$i" -le 30 ]; do
          if docker compose exec eth-node1 curl -s -X POST -H "Content-Type: application/json" \
            --data '{"jsonrpc":"2.0","method":"web3_clientVersion","params":[],"id":1}' \
            http://localhost:8545 | grep -q "2.0"; then
            echo "✅ Node ready after $((i * 10))s!"
            break
          fi
          echo "⏳ Waiting for node... ($i/30)"
          sleep 10
          i=$((i + 1))
        done
        docker compose exec eth-node1 sh -c "cd /workspace && npm install && node deploy.js"
    
    - name: Verify Results
      run: |
        docker compose logs eth-node1 --tail=10
        echo "✅ Workflow complete!"
