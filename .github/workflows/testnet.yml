name: Ethereum Testnet CI
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  testnet:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Deploy to Testnet
      shell: bash
      run: |
        mkdir -p nodes/node1/data
        
        docker compose up -d eth-node1
        
        sleep 30
        
        if ! docker ps --filter "name=eth-node1" --format '{{.Names}}' | grep -q eth-node1; then
          echo "❌ Container not running"
          docker compose logs eth-node1
          exit 1
        fi
        
        for ((i=1; i<=20; i++)); do
          if curl -s -X POST -H "Content-Type: application/json" \
            --data '{"jsonrpc":"2.0","method":"web3_clientVersion","params":[],"id":1}' \
            http://localhost:8545 | grep -q "2.0"; then
            echo "✅ RPC ready!"
            break
          fi
          echo "⏳ RPC startup ($i/20)"
          sleep 5
        done
        
        npm ci
        RPC_URL="http://localhost:8545" node deploy.js
        
        echo "✅ SUCCESS - Contract deployed!"
        cat deployment.json
    
    - name: Cleanup
      if: always()
      run: docker compose down -v
