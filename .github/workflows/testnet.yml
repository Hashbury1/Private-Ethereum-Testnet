name: Deploy Ethereum Testnet

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy Ethereum Testnet Node
        shell: bash
        run: |
          # Clean previous attempts
          docker stop eth-node 2>/dev/null || true
          docker rm eth-node 2>/dev/null || true
          rm -rf ./eth-data 2>/dev/null || true
          
          echo "üöÄ Creating genesis.json"
          cat > genesis.json << 'EOF'
          {
            "config": {
              "chainId": 1337,
              "homesteadBlock": 0,
              "eip150Block": 0,
              "eip155Block": 0,
              "eip158Block": 0,
              "byzantiumBlock": 0,
              "constantinopleBlock": 0,
              "petersburgBlock": 0,
              "istanbulBlock": 0,
              "berlinBlock": 0,
              "londonBlock": 0
            },
            "alloc": {
              "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266": {
                "balance": "0x200000000000000000000000000000000000000000000000000000000000000"
              }
            },
            "nonce": "0x0000000000000042",
            "timestamp": "0x0",
            "extraData": "0x0000000000000000000000000000000000000000000000000000000000000000",
            "gasLimit": "0x1fffffffffffff",
            "difficulty": "0x1",
            "mixHash": "0x0000000000000000000000000000000000000000000000000000000000000000",
            "coinbase": "0x0000000000000000000000000000000000000000",
            "number": "0x0",
            "gasUsed": "0x0",
            "parentHash": "0x0000000000000000000000000000000000000000000000000000000000000000"
          }
          EOF

          echo "üìÅ Creating data directory..."
          mkdir -p ./eth-data

          echo "üîß Initializing genesis block..."
          docker run --rm \
            -v $(pwd)/genesis.json:/genesis.json:ro \
            -v $(pwd)/eth-data:/data \
            ethereum/client-go:latest \
            geth init --datadir /data /genesis.json

          echo "üîë Creating password file..."
          echo "" > password.txt

          echo "üê≥ Starting Ethereum node container..."
          docker run -d \
            --name eth-node \
            -p 8545:8545 \
            -p 8546:8546 \
            -v $(pwd)/eth-data:/data \
            -v $(pwd)/password.txt:/password.txt:ro \
            ethereum/client-go:latest \
            geth \
            --datadir /data \
            --networkid 1337 \
            --http \
            --http.addr "0.0.0.0" \
            --http.port 8545 \
            --http.api "eth,net,web3,personal,admin,miner,debug,txpool" \
            --http.corsdomain "*" \
            --http.vhosts "*" \
            --ws \
            --ws.addr "0.0.0.0" \
            --ws.port 8546 \
            --ws.api "eth,net,web3,personal,admin,miner,debug,txpool" \
            --ws.origins "*" \
            --nodiscover \
            --maxpeers 0 \
            --mine \
            --miner.threads 1 \
            --miner.etherbase "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266" \
            --allow-insecure-unlock \
            --verbosity 3

          echo "‚è≥ Waiting for node to start (max 120s)..."
          NODE_READY=false
          for i in {1..24}; do
            echo "Attempt $i/24..."
            
            if curl -s -X POST -H "Content-Type: application/json" \
              --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' \
              http://localhost:8545 2>/dev/null | grep -q "result"; then
              
              BLOCK_NUMBER=$(curl -s -X POST -H "Content-Type: application/json" \
                --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' \
                http://localhost:8545 | jq -r '.result')
              
              echo "‚úÖ Node is ready!"
              echo "üìä Current block: $BLOCK_NUMBER ($(printf '%d' $BLOCK_NUMBER))"
              NODE_READY=true
              break
            fi
            
            sleep 5
          done

          if [ "$NODE_READY" = false ]; then
            echo "‚ùå Node failed to start within timeout period"
            echo "üìã Container logs:"
            docker logs eth-node
            exit 1
          fi

          echo ""
          echo "üîó Testing RPC connection..."
          RESPONSE=$(curl -s -X POST http://localhost:8545 \
            -H "Content-Type: application/json" \
            -d '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}')
          echo "Response: $RESPONSE"

          echo ""
          echo "üí∞ Checking account balance..."
          BALANCE=$(curl -s -X POST http://localhost:8545 \
            -H "Content-Type: application/json" \
            -d '{
              "jsonrpc":"2.0",
              "method":"eth_getBalance",
              "params":["0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266", "latest"],
              "id":1
            }' | jq -r '.result')
          echo "Account: 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266"
          echo "Balance: $BALANCE ($(printf '%d' $BALANCE) wei)"

          echo ""
          echo "‚úÖ Ethereum testnet node deployed successfully!"
          echo "üì° RPC Endpoint: http://localhost:8545"
          echo "üîå WebSocket: ws://localhost:8546"
          echo "üîó Chain ID: 1337"
          echo "üí≥ Pre-funded Account: 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266"

      - name: Keep node running (for testing)
        run: |
          echo "Node is running. Keeping workflow alive for 10 minutes for testing..."
          sleep 600